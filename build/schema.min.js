/*
* Schema v.0.0.1
* Rob Taylor. MIT 2014
*/
!function(a,b){b.sly=a,function(){function a(b,c){b=b||{};for(var d in c)c.hasOwnProperty(d)&&(b[d]="object"==typeof c[d]?a(b[d],c[d]):c[d]);return b}function b(){this._schemas={},this._schemaTypes={},this._schemaFormats={}}function c(a,b){m[a]=b}function d(a,b){if(k.isUndefined(b))throw new Error('property "{prop}" is required'.supplant({prop:a}));return b}function e(a,b){return k.isUndefined(a)?k.isFunction(b)?b():b:a}function f(a,b){var c;for(var d in b)b.hasOwnProperty(d)&&(c=l.schemaFormat(d),k.isFunction(c)&&(a=c(a,b[d])));return a}function g(a,b){var c=D();return setTimeout(function(){try{var d=h(a,b);c.resolve(d)}catch(e){c.reject(e)}},1),c.promise}function h(a,b){var c,g,i,j,m={};for(c in b)if(b.hasOwnProperty(c))if(i=b[c],g=e(a[c],i.default),i.required&&(g=d(c,g)),g=f(g,i),i.type){if(j=l.schemaType(i.type.name),!j(g,i))throw new Error(n.supplant({foundType:typeof g,expectType:i.type.name,val:g}));m[c]=g}else if(i.name){if(j=l.schemaType(i.name),!j(g,i))throw new Error(n.supplant({foundType:typeof g,expectType:i.name,val:g}));m[c]=g}else k.isEmpty(i)?m[c]=g:(g=h(g||{},i),k.isEmpty(g)||(m[c]=g));return m}function i(a){this.schema=a}function j(){}!function(a){"use strict";function b(a){j(function(){throw a})}function c(b){return this.then(b,a)}function d(b){return this.then(a,b)}function e(b,c){return this.then(function(a){return k(b)?b.apply(null,l(a)?a:[a]):t.onlyFuncs?a:b},c||a)}function f(a){function b(){a()}return this.then(b,b),this}function g(a){return this.then(function(b){return k(a)?a.apply(null,l(b)?b.splice(0,0,void 0)&&b:[void 0,b]):t.onlyFuncs?b:a},function(b){return a(b)})}function h(c){return this.then(a,c?function(a){throw c(a),a}:b)}function i(a,b){var c=o(a);if(1===c.length&&l(c[0])){if(!c[0].length)return t.fulfilled([]);c=c[0]}var d=[],e=t(),f=c.length;if(f)for(var g=(function(a){c[a]=t.promisify(c[a]),c[a].then(function(g){a in d||(d[a]=b?c[a]:g,--f||e.resolve(d))},function(g){a in d||(b?(d[a]=c[a],--f||e.resolve(d)):e.reject(g))})}),h=0,i=f;i>h;h++)g(h);else e.resolve(d);return e.promise}var j,k=function(a){return"function"==typeof a},l=function(a){return Array.isArray?Array.isArray(a):a instanceof Array},m=function(a){return!(!a||!(typeof a).match(/function|object/))},n=function(b){return b===!1||b===a||null===b},o=function(a,b){return[].slice.call(a,b)},p="undefined",q=typeof TypeError===p?Error:TypeError;if(typeof process!==p&&process.nextTick)j=process.nextTick;else if(typeof MessageChannel!==p){var r=new MessageChannel,s=[];r.port1.onmessage=function(){s.length&&s.shift()()},j=function(a){s.push(a),r.port2.postMessage(0)}}else j=function(a){setTimeout(a,0)};var t=function(b){function i(){if(0!==s){var a,b=u,c=0,d=b.length,e=~s?0:1;for(u=[];d>c;c++)(a=b[c][e])&&a(p)}}function l(a){function b(a){return function(b){return c?void 0:(c=!0,a(b))}}var c=!1;if(s)return this;try{var d=m(a)&&a.then;if(k(d)){if(a===v)throw new q("Promise can't resolve itself");return d.call(a,b(l),b(o)),this}}catch(e){return b(o)(e),this}return r(function(){p=a,s=1,i()}),this}function o(a){return s||r(function(){try{throw a}catch(b){p=b}s=-1,i()}),this}var p,r=(a!==b?b:t.alwaysAsync)?j:function(a){a()},s=0,u=[],v={then:function(a,b){var c=t();return u.push([function(b){try{c.resolve(n(a)?b:k(a)?a(b):t.onlyFuncs?b:a)}catch(d){c.reject(d)}},function(a){if((n(b)||!k(b)&&t.onlyFuncs)&&c.reject(a),b)try{c.resolve(k(b)?b(a):b)}catch(d){c.reject(d)}}]),0!==s&&r(i),c.promise},success:c,error:d,otherwise:d,apply:e,spread:e,ensure:f,nodify:g,rethrow:h,isPending:function(){return!(0!==s)},getStatus:function(){return s}};return v.toSource=v.toString=v.valueOf=function(){return p===a?this:p},{promise:v,resolve:l,fulfill:l,reject:o}};t.deferred=t.defer=t,t.nextTick=j,t.alwaysAsync=!0,t.onlyFuncs=!0,t.resolved=t.fulfilled=function(a){return t(!0).resolve(a).promise},t.rejected=function(a){return t(!0).reject(a).promise},t.wait=function(a){var b=t();return setTimeout(b.resolve,a||0),b.promise},t.delay=function(a,b){var c=t();return setTimeout(function(){try{c.resolve(a.apply(null))}catch(b){c.reject(b)}},b||0),c.promise},t.promisify=function(a){return a&&k(a.then)?a:t.resolved(a)},t.all=function(){return i(arguments,!1)},t.resolveAll=function(){return i(arguments,!0)},t.nodeCapsule=function(a,b){return b||(b=a,a=void 0),function(){var c=t(),d=o(arguments);d.push(function(a,b){a?c.reject(a):c.resolve(arguments.length>2?o(arguments,1):b)});try{b.apply(a,d)}catch(e){c.reject(e)}return c.promise}},typeof window!==p&&(window.D=t),typeof module!==p&&module.exports&&(module.exports=t)}();var k;window._?k=window._:(Array.prototype.isArray=!0,k={},k.extend=a,k.isString=function(a){return"string"==typeof a},k.isBoolean=function(a){return"boolean"==typeof a},k.isNumber=function(a){return"number"==typeof a},k.isDate=function(a){return a instanceof Date&&!isNaN(a.valueOf())},k.isArray=function(a){return!!a.isArray},k.isEmpty=function(a){if(k.isString(a))return""===a;if(k.isArray(a))return 0===a.length;if(k.isObject(a)){for(var b in a)return!1;return!0}return!1},k.isUndefined=function(a){return"undefined"==typeof a},k.isFunction=function(a){return"function"==typeof a},k.isObject=function(a){return"object"==typeof a}),b.prototype.schemaType=function(a,b){return k.isUndefined(b)?this._schemaTypes[a]:(this.Schema.Types[a]={name:a},void(this._schemaTypes[a]=b))},b.prototype.schemaFormat=function(a,b){return k.isUndefined(b)?this._schemaFormats[a]:(this.Schema.Types[a]={name:a},void(this._schemaFormats[a]=b))},b.prototype.model=function(a,b){return k.isUndefined(b)?l.Model.factory(a,this._schemas[a]):void(this._schemas[a]=b)};var l=new b;window.sly=l;var m={},n='Schema found type "{foundType}" where it expected type "{expectType}" => {val}';i.type=c,i.Types={},i.prototype.applySchema=function(a){return g(a,this.schema)},l.Schema=i,j.extend=function(a,b){var c=/^([\w\$]+)$/.test(a);if(!c)throw new Error('Invalid name: "{name}"'.supplant({name:a}));this.prototype[a]=b},j.factory=function(a,b){function c(a){k.extend(this,a)}return c.statics={},c.prototype=j.prototype,c.prototype.getName=function(){return a},c.prototype.getSchema=function(){return b},c},l.Model=j,l.schemaFormat("trim",function(a,b){return b&&(a=String(a).trim()),a}),l.Model.extend("check",function(){return this.getSchema().applySchema(this,arguments)}),String.prototype.supplant=function(a){"use strict";return this.replace(/{([^{}]*)}/g,function(b,c){var d=a[c];return"string"==typeof d||"number"==typeof d?d:b})},l.schemaType("Boolean",function(a){return k.isBoolean(a)}),l.schemaType("Date",function(a){return k.isDate(a)||k.isNumber(a)});var o=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;l.schemaType("Email",function(a){return o.test(a)}),l.schemaType("Mixed",function(){return!0}),l.schemaType("Number",function(a){return k.isNumber(a)});var p=/^\s*(\-)?\d+\s*$/;l.schemaType("Int",function(a){return-1!==String(a).search(p)});var q=/^\s*(\+|-)?((\d+(\.\d\d)?)|(\.\d\d))\s*$/;l.schemaType("Currency",function(a){var b=-1!==String(a).search(q);if(!b)throw new Error("Currency can have either 0 or 2 decimal places. => "+a);return b}),l.schemaType("String",function(a){return k.isString(a)})}()}({},function(){return this}());